<div><style type="text/css">.sheet .disabled{background:#eee;color:#777}.sheet .number{text-align:right}.sheet .hl{border-bottom:2px solid #000}.sheet .name-field{white-space:pre-wrap;word-break:break-all}.sheet .cell,.sheet .edit textarea{max-height:200px}[ld=total].text-danger:after{font-family:ldi;display:inline;content:"\f03d";font-size:.85em;margin-left:.5em}.lc-sheet-viewer .lc-sheet-row .form-control{height:auto}.lc-sheet-row,.lc-sheet-no-row{display:flex;position:relative}.lc-sheet-row .form-control,.lc-sheet-no-row .form-control{width:5.5em;box-shadow:none !important;resize:none}.lc-sheet-row i.i-close,.lc-sheet-no-row i.i-close{position:absolute;top:0;bottom:0;margin:auto;line-height:1em;height:fit-content;font-size:.6em;background:#fff;padding:.25em;border-radius:50%;border:1px solid var(--danger);color:var(--danger);left:-0.75em;cursor:pointer}.lc-sheet-row .form-control,.lc-sheet-no-row .form-control,.lc-sheet-row .row-head,.lc-sheet-no-row .row-head{flex:1 1 auto}.lc-sheet-row .form-control:not(:last-child),.lc-sheet-no-row .form-control:not(:last-child){border-right:0;border-top-right-radius:0;border-bottom-right-radius:0}.lc-sheet-row .form-control:not(:nth-child(-n+2)),.lc-sheet-no-row .form-control:not(:nth-child(-n+2)),.lc-sheet-row .row-head:not(:nth-child(-n+1)),.lc-sheet-no-row .row-head:not(:nth-child(-n+1)){border-top-left-radius:0;border-bottom-left-radius:0}.lc-sheet-row:not(:last-child) .form-control{border-bottom-left-radius:0;border-bottom-right-radius:0;border-bottom:0}.lc-sheet-row:not(:nth-child(1)) .form-control,.lc-sheet-no-row .form-control{border-top-left-radius:0;border-top-right-radius:0}td{padding:.25em}table,th,td{border:1px solid #ddd;border-collapse:collapse}tr.row-head{background:#eee;color:#777}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"@makeform/budget",extend:{name:"@makeform/common"},dependencies:[{name:"papaparse",path:"papaparse.min.js"},{name:"@plotdb/sheet"},{name:"@plotdb/sheet",type:"css"}],i18n:{en:{"單位":"Unit","總金額":"Subtotal","追加":"Add","無資料":"No Data"},"zh-TW":{"單位":"單位","總金額":"總金額","追加":"追加","無資料":"無資料"}}},init:function(t){return t.pubsub.fire("subinit",{mod:mod(t)})}};mod=function(t){var n,e,r,a,h,m;n=t.root,e=t.ctx,r=t.data,a=t.parent,h=t.t;m=e.sheet;return{init:function(){var i,u,o,d,e,g,l,y,r,s,a,c,f=this;i={total:0,mode:"edit"};this.on("change",function(t){var e,n;t==null&&(t={});i.total=t.total||0;i.subsidy=t.subsidy||0;e=JSON.parse(JSON.stringify(t.data))||[];e=[d.map(function(t){return h(t.name)})].concat(e);i._data=JSON.parse(JSON.stringify(e))||[];n=r(i._data);i.total=n.total;i.subsidy=n.subsidy;if(i.sheet){i.sheet.data(JSON.parse(JSON.stringify(n.data)))}s(i._data);return a.render("total","no-row","row","head")});this.on("mode",function(t){i.mode=t;if(i.sheet){i.sheet.render()}return a.render("no-row","row","head","sheet","table","table-viewer","sheet-viewer")});u=function(){return(f.mod.info.config||{}).mode==="table"};o=function(){var t;t=f.mod.info.config.meta||{};return i.mode==="view"||t.disabled||t.readonly};d=(this.mod.info.config||{}).fields||[];i._data=[d.map(function(t){return t})];["total price"].filter(function(e){return!d.filter(function(t){return t.type===e}).length}).forEach(function(t){return d.push({name:t,type:t})});d.map(function(t,e){return t.idx=e});this.mod.child.sheetUpdate=function(){var t,e;if(!i.sheet){return}t=i.sheet.data();t.splice(0,1);t=[d.map(function(t){return h(t.name)})].concat(t);e=r(t);i.total=e.total;i.subsidy=e.subsidy;return i.sheet.data(e.data)};e=d.map(function(t){return t.type});g={};["name","unit price","quantity","total price","self-fund","subsidy"].map(function(t){return g[t]=e.indexOf(t)});l=d.map(function(t){return function(){switch(t.type){case"total price":if(~g["unit price"]&&~g["quantity"]){return"disabled number"}else{return"number"}case"subsidy":return"disabled number";case"self-fund":return"number";case"unit price":return"number";case"quantity":return"number";case"name":return"name-field";default:return""}}()});y=function(t){return(t+"").trim().replace(/,/g,"")};r=function(t){var e,n,r,a,i,u,o,d,l,s,c,f,h,m,p;e=0;n=0;r=g["unit price"];a=g["quantity"];i=g["total price"];u=g["self-fund"];o=g["subsidy"];if(!(~r&&~a)){for(d=1,l=t.length;d<l;++d){s=d;c=t[s][i]!=null&&!isNaN(y(t[s][i]))?+y(t[s][i]):0;e+=c||0}}else{for(d=1,l=t.length;d<l;++d){s=d;f=[t[s][r],t[s][a]].map(v),h=f[0],m=f[1];c=h!==""&&m!==""?+y(h)*+y(m):"";c=c===""?"":c!=null&&!isNaN(c)?+c:0;t[s][i]=c;e+=c||0}}if(~o){for(d=1,l=t.length;d<l;++d){s=d;p=((~u?t[s][u]!=null?t[s][u]:"":void 8)+"").trim();p=isNaN(+y(p))||!p?0:+y(p);c=t[s][o]=t[s][i]==null||t[s][i]===""?"":(f=+y(t[s][i])-p)>0?f:0;c=!c?0:isNaN(parseFloat(c))?0:+c;n+=c||0}}return{data:t,total:e,subsidy:n};function v(t){return y(((t!=null?t:"")+"").trim())}};s=function(t,e){var n;n=r(t);i.total=n.total;i.subsidy=n.subsidy;t=JSON.parse(JSON.stringify(n.data));t.splice(0,1);f.value({total:i.total,subsidy:i.subsidy,data:t}).then(function(){a.render("total");if(!e){return}e.render();return c().now()});return n};this.mod.child.view=a=new ldview({root:n,init:{sheet:function(t){var e,n,r,a;e=t.node,n=t.ctx;if(u()){return}r=d.map(function(t){var e;e=t.width||"";if(t.type==="name"&&!e){e="190px"}return e});i.sheet=a=new m({root:e,slider:true,data:[d.map(function(t){return h(t.name)})],frozen:{row:1},size:{col:r},class:{row:["hl"]},scrollLock:true,enableScrolling:false,cellcfg:function(t){var e,n,r;e=t.row,n=t.col,r=t.type;if(r==="readonly"){if(o()){return true}if(e===0){return true}if(l[n]==="disabled"){return true}return false}if(r==="class"){if(e===0){return"disabled"}return l[n]||""}}});return a.on("change",function(){var t,e;if(o()){return a.data(JSON.parse(JSON.stringify(i._data)))}t=a.data();e=s(t);return a.data(e.data)})}},action:{click:{add:function(t){var e;e=t.node;i._data.push(d.map(function(){return""}));return s(i._data,a)}}},handler:{sheet:function(t){var e;e=t.node;return e.classList.toggle("d-none",f.mode()==="view"||u())},table:function(t){var e;e=t.node;return e.classList.toggle("d-none",f.mode()==="view"||!u())},"table-viewer":function(t){var e;e=t.node;return e.classList.toggle("d-none",f.mode()!=="view"||!u())},"sheet-viewer":function(t){var e;e=t.node;return e.classList.toggle("d-none",f.mode()!=="view"||u())},total:function(t){var e;e=t.node;return e.classList.toggle("text-danger",f.status()===2)},head:{list:function(){return d},key:function(t){return t.idx},view:{handler:{"@":function(t){var e,n;e=t.node,n=t.ctx;e.innerText=h(n.name);return e.style.width=n.width||(n.type==="name"?"200px":"")}}}},"no-row":function(t){var e,n;e=t.node;n=(i._data||[]).filter(function(t){return t&&t.filter&&t.filter(function(t){return t!=null}).length}).length<2;return e.classList.toggle("d-none",!n)},row:{list:function(){var e,t;e=u();t=(i._data||[]).map(function(t,e){return{data:t,idx:e}});t=t.filter(function(t){return t&&t.data.filter&&t.data.filter(function(t){return t!=null&&(e||t!=="")}).length}).slice(1);return t},key:function(t){return t.idx},view:{action:{click:{delete:function(t){var e,n,r;e=t.ctx,n=t.views;i._data.splice(e.idx,1);return r=s(i._data,a)}}},handler:{col:{list:function(){return d},key:function(t){return t.idx},view:{handler:{"@":function(t){var e,n,r,a,i;e=t.node,n=t.ctx,r=t.ctxs,a=t.views;e.style.width=n.width||(n.type==="name"?"200px":"");i=r[0].data[n.idx]!=null?r[0].data[n.idx]:"";e.value=i;e.innerText=i;return c()}},action:{input:{"@":function(t){var e,n,r,a;e=t.node,n=t.ctx,r=t.ctxs,a=t.views;i._data[r[0].idx][n.idx]=e.value||"";return s(i._data,a[1])}},change:{"@":function(t){var e,n,r,a;e=t.node,n=t.ctx,r=t.ctxs,a=t.views;i._data[r[0].idx][n.idx]=e.value||"";return s(i._data,a[1])}}}}}}}}},text:{total:function(t){var e;e=t.node;return i.total||0},unit:function(t){var e;e=t.node;return h(f.mod.info.config.unit||"")}}});return c=debounce(function(){return ld$.find(n,".lc-sheet-row").map(function(t){var e,n;e=ld$.find(t,"textarea");e.map(function(t){return t.style.height="0px"});n=Math.max.apply(Math,e.map(function(t){return t.scrollHeight}));return e.map(function(t){return t.style.height=n+2+"px"})})})},render:function(){if(this.mod.child.view){this.mod.child.view.render()}if(this.mod.child.sheetUpdate){return this.mod.child.sheetUpdate()}},isEmpty:function(t){return!(t&&t.data&&t.data.length&&t.data.filter(function(t){return t.length}).length)},isEqual:function(t,e){var n,r,a,i,u,o,d,l,s,c,f;n=[this.isEmpty(t),this.isEmpty(e)],r=n[0],a=n[1];if(r&&a){return true}if(r||a){return false}if(t.total!==e.total){return false}if(t.data.length!==e.data.length){return false}for(i=0,u=t.data.length;i<u;++i){o=i;n=[t.data[o],e.data[o]],d=n[0],l=n[1];if(d.length!==l.length){return false}for(s=0,c=d.length;s<c;++s){f=s;if(d[f]!==l[f]){return false}}}return true},content:function(t){return t}}};</script><div class="form-group has-tips manual" ld="base error-root" plug="widget" style="cursor:default"><div ld="display" data-display="block"><label class="d-flex align-items-end flex-wrap"><div><span ld="label"></span><span class="text-danger ml-2" ld="is-required">*</span></div><div class="flex-grow-1"></div><div class="m-edit"><div class="mf-note text-sm" ld="limitation"></div></div></label></div><div class="text-sm text-muted" ld="display" data-display="block"><div ld="desc" style="margin:-.6em 0 .7em"></div></div><div class="rounded shadow-sm border mb-2 aspect-ratio ratio-3by2 w-100" ld="sheet"></div><div class="mb-2" ld="sheet-viewer"><table class="w-100 rounded shadow-sm"><tr class="row-head"><td ld-each="head"></td></tr><tr ld="no-row"><td class="text-muted" t="無資料"></td></tr><tr ld-each="row"><td ld-each="col"></td></tr></table></div><div class="mb-2" ld="table"><div class="mb-2"><div class="lc-sheet-row"><div class="row-head form-control" ld-each="head"></div></div><div class="lc-sheet-no-row" ld="no-row"><div class="form-control text-muted" t="無資料"></div></div><div class="lc-sheet-row" ld-each="row"><i class="i-close" ld="delete"></i><textarea class="form-control" ld-each="col"></textarea></div></div></div><div class="mb-2" ld="table-viewer"><div class="mb-2 lc-sheet-viewer"><div class="lc-sheet-row"><div class="row-head form-control" ld-each="head"></div></div><div class="lc-sheet-no-row" ld="no-row"><div class="form-control text-muted" t="無資料"></div></div><div class="lc-sheet-row" ld-each="row"><div class="form-control" ld-each="col"></div></div></div></div><div class="d-flex justify-content-between align-items-start"><div class="d-flex g-4 align-items-start"><div class="d-flex g-2 align-items-end"><div><span t>總金額</span>:</div><div class="d-flex align-items-center" ld="total"></div><div class="text-sm text-muted" ld="unit"></div></div><div class="m-edit d-flex g-1 flex-wrap"><div class="text-danger" ld-each="error"></div></div></div><div ld="table"><div class="btn btn-sm btn-outline-secondary" t="追加" ld="add"></div></div></div><div class="m-edit" ld="display" data-display="block"><div class="mf-note text-sm mt-2 note" ld-each="note"></div></div></div></div>
