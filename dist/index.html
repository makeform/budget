<div><style type="text/css">.sheet .disabled{background:#eee;color:#777}.sheet .hl{border-bottom:2px solid #000}.sheet .name-field{white-space:normal;word-break:break-all}.sheet .cell,.sheet .edit textarea{max-height:300px}[ld=total].text-danger:after{font-family:ldi;display:inline;content:"\f03d";font-size:.85em;margin-left:.5em}.lc-sheet-viewer .lc-sheet-row .form-control{height:auto}.lc-sheet-row,.lc-sheet-no-row{display:flex;position:relative}.lc-sheet-row .form-control,.lc-sheet-no-row .form-control{width:0;box-shadow:none !important;resize:none}.lc-sheet-row i.i-close,.lc-sheet-no-row i.i-close{position:absolute;top:0;bottom:0;margin:auto;line-height:1em;height:fit-content;font-size:.6em;background:#fff;padding:.25em;border-radius:50%;border:1px solid var(--danger);color:var(--danger);left:-0.75em;cursor:pointer}.lc-sheet-row .form-control,.lc-sheet-no-row .form-control,.lc-sheet-row .row-head,.lc-sheet-no-row .row-head{flex:1 1 auto}.lc-sheet-row .form-control:not(:last-child),.lc-sheet-no-row .form-control:not(:last-child){border-right:0;border-top-right-radius:0;border-bottom-right-radius:0}.lc-sheet-row .form-control:not(:nth-child(-n+2)),.lc-sheet-no-row .form-control:not(:nth-child(-n+2)){border-top-left-radius:0;border-bottom-left-radius:0}.lc-sheet-row:not(:last-child) .form-control{border-bottom-left-radius:0;border-bottom-right-radius:0;border-bottom:0}.lc-sheet-row:not(:nth-child(1)) .form-control,.lc-sheet-no-row .form-control{border-top-left-radius:0;border-top-right-radius:0}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"@makeform/budget",extend:{name:"@makeform/common"},dependencies:[{name:"papaparse",path:"papaparse.min.js"},{name:"@plotdb/sheet"},{name:"@plotdb/sheet",type:"css"}],i18n:{en:{"單位":"unit","總金額":"Subtotal","追加":"Add","無資料":"No Data"},"zh-TW":{unit:"單位","總金額":"總金額","追加":"追加","無資料":"無資料"}}},init:function(t){return t.pubsub.fire("subinit",{mod:mod(t)})}};mod=function(t){var c,n,e,r,s,p,m;c=t.root,n=t.ctx,e=t.data,r=t.parent,s=t.t;p=n.sheet;m={total:0,mode:"edit"};return{init:function(){var e,i,u,n,h,o,r,d,l,f,a=this;this.on("change",function(t){var n;t==null&&(t={});m.total=t.total||0;n=JSON.parse(JSON.stringify(t.data))||[];n=[u.map(function(t){return s(t.name)})].concat(n);m._data=JSON.parse(JSON.stringify(n))||[];if(m.sheet){m.sheet.data(n)}return l.render("total","no-row","row","head")});this.on("mode",function(t){m.mode=t;if(m.sheet){m.sheet.render()}return l.render("no-row","row","head","sheet","table","viewer")});e=function(){return(a.mod.info.config||{}).mode==="table"};i=function(){var t;t=a.mod.info.config.meta||{};return m.mode==="view"||t.disabled||t.readonly};u=(this.mod.info.config||{}).fields||[];m._data=[u.map(function(t){return t})];["total price"].filter(function(n){return!u.filter(function(t){return t.type===n}).length}).forEach(function(t){return u.push({name:t,type:t})});u.map(function(t,n){return t.idx=n});n=u.map(function(t){return t.type});h={};["name","unit price","quantity","total price"].map(function(t){return h[t]=n.indexOf(t)});o=u.map(function(t){return function(){switch(t.type){case"total price":if(~h["unit price"]&&~h["quantity"]){return"disabled"}else{return""}case"name":return"name-field";default:return""}}()});r=function(t){var n,e,r,a,i,u,o,d,l,f,c;n=0;e=h["unit price"];r=h["quantity"];a=h["total price"];if(!(~e&&~r)){for(i=1,u=t.length;i<u;++i){o=i;d=t[o][a]!=null&&!isNaN(t[o][a])?+t[o][a]:0;n+=d||0}}else{for(i=1,u=t.length;i<u;++i){o=i;l=[t[o][e],t[o][r]].map(s),f=l[0],c=l[1];d=f!==""&&c!==""?+f*+c:"";d=d===""?"":d!=null&&!isNaN(d)?+d:0;t[o][a]=d;n+=d||0}}return{data:t,sum:n};function s(t){return((t!=null?t:"")+"").trim()}};d=function(t,n){var e;e=r(t);m.total=e.sum;t=JSON.parse(JSON.stringify(e.data));t.splice(0,1);a.value({total:m.total,data:t}).then(function(){l.render("total");if(!n){return}n.render();return f().now()});return e};l=new ldview({root:c,init:{sheet:function(t){var n,e,r,a;n=t.node,e=t.ctx;r=u.map(function(t){var n;n=t.width||"";if(t.type==="name"&&!n){n="250px"}return n});m.sheet=a=new p({root:n,slider:true,data:[u.map(function(t){return s(t.name)})],frozen:{row:1},size:{col:r},class:{row:["hl"]},scrollLock:true,enableScrolling:false,cellcfg:function(t){var n,e,r;n=t.row,e=t.col,r=t.type;if(r==="readonly"){if(i()){return true}if(n===0){return true}if(o[e]==="disabled"){return true}return false}if(r==="class"){if(n===0){return"disabled"}return o[e]||""}}});return a.on("change",function(){var t,n;if(i()){return a.data(JSON.parse(JSON.stringify(m._data)))}t=a.data();n=d(t);return a.data(n.data)})}},action:{click:{add:function(t){var n;n=t.node;m._data.push(u.map(function(){return""}));return d(m._data,l)}}},handler:{sheet:function(t){var n;n=t.node;return n.classList.toggle("d-none",a.mode()==="view"||e())},table:function(t){var n;n=t.node;return n.classList.toggle("d-none",a.mode()==="view"||!e())},viewer:function(t){var n;n=t.node;return n.classList.toggle("d-none",a.mode()!=="view")},total:function(t){var n;n=t.node;return n.classList.toggle("text-danger",a.status()===2)},head:{list:function(){return u},key:function(t){return t.idx},view:{handler:{"@":function(t){var n,e;n=t.node,e=t.ctx;n.innerText=e.name;return n.style.width=e.width||""}}}},"no-row":function(t){var n,e;n=t.node;e=(m._data||[]).filter(function(t){return t&&t.filter&&t.filter(function(t){return t!=null}).length}).length<2;return n.classList.toggle("d-none",!e)},row:{list:function(){var t;t=(m._data||[]).map(function(t,n){return{data:t,idx:n}});return t.filter(function(t){return t&&t.data.filter&&t.data.filter(function(t){return t!=null}).length}).slice(1)},key:function(t){return t.idx},view:{action:{click:{delete:function(t){var n,e,r,a;n=t.ctx,e=t.views;m._data.splice(n.idx,1);r=JSON.parse(JSON.stringify(m._data));r.splice(0,1);return a=d(r,l)}}},handler:{col:{list:function(){return u},key:function(t){return t},view:{handler:{"@":function(t){var n,e,r,a,i;n=t.node,e=t.ctx,r=t.ctxs,a=t.views;n.style.width=e.width||"";i=r[0].data[e.idx]||"";n.value=i;n.innerText=i;return f()}},action:{input:{"@":function(t){var n,e,r,a;n=t.node,e=t.ctx,r=t.ctxs,a=t.views;m._data[r[0].idx][e.idx]=n.value||"";return d(m._data,a[1])}},change:{"@":function(t){var n,e,r,a;n=t.node,e=t.ctx,r=t.ctxs,a=t.views;m._data[r[0].idx][e.idx]=n.value||"";return d(m._data,a[1])}}}}}}}}},text:{total:function(t){var n;n=t.node;return m.total||0},unit:function(t){var n;n=t.node;return s(a.mod.info.config.unit||"")}}});return f=debounce(function(){return ld$.find(c,".lc-sheet-row").map(function(t){var n,e;n=ld$.find(t,"textarea");n.map(function(t){return t.style.height="0px"});e=Math.max.apply(Math,n.map(function(t){return t.scrollHeight}));return n.map(function(t){return t.style.height=e+"px"})})})},render:function(){},isEmpty:function(t){return!(t&&t.data&&t.data.length&&t.data.filter(function(t){return t.length}).length)},isEqual:function(t,n){var e,r,a,i,u,o,d,l,f,c,s;e=[this.isEmpty(t),this.isEmpty(n)],r=e[0],a=e[1];if(r&&a){return true}if(r||a){return false}if(t.total!==n.total){return false}if(t.data.length!==n.data.length){return false}for(i=0,u=t.data.length;i<u;++i){o=i;e=[t.data[o],n.data[o]],d=e[0],l=e[1];if(d.length!==l.length){return false}for(f=0,c=d.length;f<c;++f){s=f;if(d[s]!==l[s]){return false}}}return true},content:function(t){return t}}};</script><div class="form-group has-tips manual" ld="base error-root" plug="widget" style="cursor:default"><div ld="display" data-display="block"><label class="d-flex align-items-end flex-wrap"><div><span ld="label"></span><span class="text-danger ml-2" ld="is-required">*</span></div><div class="flex-grow-1"></div><div class="m-edit"><div class="mf-note text-sm" ld="limitation"></div></div></label></div><div class="text-sm text-muted" ld="display" data-display="block"><div ld="desc" style="margin:-.6em 0 .7em"></div></div><div class="rounded shadow-sm border mb-2 aspect-ratio ratio-3by2 w-100" ld="sheet"></div><div class="mb-2" ld="table"><div class="mb-2"><div class="lc-sheet-row"><div class="row-head form-control" ld-each="head"></div></div><div class="lc-sheet-no-row" ld="no-row"><div class="form-control text-muted" t="無資料"></div></div><div class="lc-sheet-row" ld-each="row"><i class="i-close" ld="delete"></i><textarea class="form-control" ld-each="col"></textarea></div></div></div><div class="mb-2" ld="viewer"><div class="mb-2 lc-sheet-viewer"><div class="lc-sheet-row"><div class="row-head form-control" ld-each="head"></div></div><div class="lc-sheet-no-row" ld="no-row"><div class="form-control text-muted" t="無資料"></div></div><div class="lc-sheet-row" ld-each="row"><div class="form-control" ld-each="col"></div></div></div></div><div class="d-flex justify-content-between"><div class="d-flex g-2 align-items-end"><div><span t>總金額</span>:</div><div class="d-flex align-items-center" ld="total"></div><div class="text-sm text-muted" ld="unit"></div></div><div ld="table"><div class="btn btn-sm btn-outline-secondary" t="追加" ld="add"></div></div></div><div class="m-edit"><div class="hover-tip tip-sm"><div ld-each="error"></div></div></div><div class="m-edit" ld="display" data-display="block"><div class="mf-note text-sm mt-2 note" ld-each="note"></div></div></div></div>
